<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>carbon_model.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1667526-20']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
</head>

<body>
<div id='container'>
  <div id="background"></div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>carbon_model.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        <p>Copyright Â© 2010 Brighter Planet.
See LICENSE for details.
Contact Brighter Planet for dual-license arrangements.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">module</span> <span class="nn">BrighterPlanet</span>
  <span class="k">module</span> <span class="nn">Diet</span>
    <span class="k">module</span> <span class="nn">CarbonModel</span>
      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">included</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
        <span class="n">base</span><span class="o">.</span><span class="n">decide</span> <span class="ss">:emission</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="ss">:characteristics</span> <span class="k">do</span>
          <span class="n">committee</span> <span class="ss">:emission</span> <span class="k">do</span> <span class="c1"># returns kg CO2</span>
            <span class="n">quorum</span> <span class="s1">&#39;from intensity and size&#39;</span><span class="p">,</span> <span class="ss">:needs</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:intensity</span><span class="p">,</span> <span class="ss">:size</span><span class="p">,</span> <span class="ss">:active_subtimeframe</span><span class="o">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">characteristics</span><span class="o">|</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>( grams CO2 / kcal food   ) * (   kcal food         )</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>              <span class="p">(</span><span class="n">characteristics</span><span class="o">[</span><span class="ss">:intensity</span><span class="o">]</span> <span class="o">*</span> <span class="n">characteristics</span><span class="o">[</span><span class="ss">:size</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">grams</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="ss">:kilograms</span><span class="p">)</span> <span class="o">*</span> <span class="n">characteristics</span><span class="o">[</span><span class="ss">:active_subtimeframe</span><span class="o">].</span><span class="n">days</span>
            <span class="k">end</span>
            <span class="n">quorum</span> <span class="s1">&#39;default&#39;</span> <span class="k">do</span>
              <span class="k">raise</span> <span class="s1">&#39;Diet emission committee default quorum should never be called&#39;</span>
            <span class="k">end</span>
          <span class="k">end</span>
      
          <span class="n">committee</span> <span class="ss">:intensity</span> <span class="k">do</span> <span class="c1"># returns grams CO2 / kcal food</span>
            <span class="n">quorum</span> <span class="s1">&#39;from food groups&#39;</span><span class="p">,</span> <span class="ss">:needs</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:red_meat_share</span><span class="p">,</span> <span class="ss">:poultry_share</span><span class="p">,</span> <span class="ss">:fish_share</span><span class="p">,</span> <span class="ss">:eggs_share</span><span class="p">,</span> <span class="ss">:nuts_share</span><span class="p">,</span> <span class="ss">:dairy_share</span><span class="p">,</span> <span class="ss">:cereals_and_grains_share</span><span class="p">,</span> <span class="ss">:fruit_share</span><span class="p">,</span> <span class="ss">:vegetables_share</span><span class="p">,</span> <span class="ss">:oils_and_sugars_share</span><span class="o">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">characteristics</span><span class="o">|</span>
              <span class="o">[</span><span class="ss">:red_meat</span><span class="p">,</span> <span class="ss">:poultry</span><span class="p">,</span> <span class="ss">:fish</span><span class="p">,</span> <span class="ss">:eggs</span><span class="p">,</span> <span class="ss">:nuts</span><span class="p">,</span> <span class="ss">:dairy</span><span class="p">,</span> <span class="ss">:cereals_and_grains</span><span class="p">,</span> <span class="ss">:fruit</span><span class="p">,</span> <span class="ss">:vegetables</span><span class="p">,</span> <span class="ss">:oils_and_sugars</span><span class="o">].</span><span class="n">sum</span> <span class="k">do</span> <span class="o">|</span><span class="n">group</span><span class="o">|</span>
                <span class="n">characteristics</span><span class="o">[</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">group</span><span class="si">}</span><span class="s2">_share&quot;</span><span class="o">.</span><span class="n">to_sym</span><span class="o">].</span><span class="n">to_f</span> <span class="o">*</span> <span class="no">FoodGroup</span><span class="o">[</span><span class="n">group</span><span class="o">].</span><span class="n">intensity</span><span class="o">.</span><span class="n">to_f</span>
              <span class="k">end</span>
            <span class="k">end</span>
      
            <span class="n">quorum</span> <span class="s1">&#39;from diet class&#39;</span><span class="p">,</span> <span class="ss">:needs</span> <span class="o">=&gt;</span> <span class="ss">:diet_class</span> <span class="k">do</span> <span class="o">|</span><span class="n">characteristics</span><span class="o">|</span>
              <span class="n">characteristics</span><span class="o">[</span><span class="ss">:diet_class</span><span class="o">].</span><span class="n">intensity</span>
            <span class="k">end</span>
          <span class="k">end</span>
      
          <span class="n">committee</span> <span class="ss">:size</span> <span class="k">do</span> <span class="c1"># returns kcal food</span>
            <span class="n">quorum</span> <span class="s1">&#39;default&#39;</span> <span class="k">do</span>
              <span class="n">base</span><span class="o">.</span><span class="n">fallback</span><span class="o">.</span><span class="n">size</span>
            <span class="k">end</span>
          <span class="k">end</span>
      
          <span class="n">committee</span> <span class="ss">:diet_class</span> <span class="k">do</span>
            <span class="n">quorum</span> <span class="s1">&#39;default&#39;</span> <span class="k">do</span>
              <span class="no">DietClass</span><span class="o">.</span><span class="n">fallback</span>
            <span class="k">end</span>
          <span class="k">end</span>
      
          <span class="n">committee</span> <span class="ss">:active_subtimeframe</span> <span class="k">do</span>
            <span class="n">quorum</span> <span class="s1">&#39;from start and end dates&#39;</span><span class="p">,</span> <span class="ss">:needs</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:start_date</span><span class="p">,</span> <span class="ss">:end_date</span><span class="o">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">characteristics</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">|</span>
              <span class="no">Timeframe</span><span class="o">.</span><span class="n">constrained_new</span> <span class="n">characteristics</span><span class="o">[</span><span class="ss">:start_date</span><span class="o">]</span><span class="p">,</span> <span class="n">characteristics</span><span class="o">[</span><span class="ss">:end_date</span><span class="o">]</span><span class="p">,</span> <span class="n">timeframe</span>
            <span class="k">end</span>
          <span class="k">end</span>
          
          <span class="n">committee</span> <span class="ss">:start_date</span> <span class="k">do</span>
            <span class="n">quorum</span> <span class="s1">&#39;from end date&#39;</span><span class="p">,</span> <span class="ss">:appreciates</span> <span class="o">=&gt;</span> <span class="ss">:end_date</span> <span class="k">do</span> <span class="o">|</span><span class="n">characteristics</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">|</span>
              <span class="o">[</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">from</span><span class="p">,</span> <span class="n">characteristics</span><span class="o">[</span><span class="ss">:end_date</span><span class="o">]</span> <span class="o">].</span><span class="n">compact</span><span class="o">.</span><span class="n">min</span>
            <span class="k">end</span>
          <span class="k">end</span>
          
          <span class="n">committee</span> <span class="ss">:end_date</span> <span class="k">do</span>
            <span class="n">quorum</span> <span class="s1">&#39;from start date&#39;</span><span class="p">,</span> <span class="ss">:appreciates</span> <span class="o">=&gt;</span> <span class="ss">:start_date</span> <span class="k">do</span> <span class="o">|</span><span class="n">characteristics</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">|</span>
              <span class="o">[</span> <span class="n">timeframe</span><span class="o">.</span><span class="n">to</span><span class="p">,</span> <span class="n">characteristics</span><span class="o">[</span><span class="ss">:start_date</span><span class="o">]</span> <span class="o">].</span><span class="n">compact</span><span class="o">.</span><span class="n">max</span>
            <span class="k">end</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
